<!DOCTYPE html>
<html lang="en">
<head>
    <title>Draw</title>
    <meta charset="UTF-8">
    <meta name="description" content="This is a description.">
    <meta name="keywords" content="keyword">
    <link rel="icon" href="/icon512_rounded.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js?" defer type="text/javascript" crossorigin="anonymous"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js?" defer type="text/javascript" crossorigin="anonymous"></script>
    <script src="../client/script/css_dev_watch.js?" defer type="text/javascript"></script>
    <script src="../client/script/iframe_detect.js?" defer type="text/javascript"></script>
    <script src="../client/script/edit_detect.js?" defer type="text/javascript"></script>
    <script src="../client/script/socket.js?" defer type="text/javascript"></script>
    <script src="../client/script/get_path.js?" defer type="text/javascript"></script>
    <link href="../client/style/variables.css?" rel="stylesheet">
    <link href="../client/style/reset.css?" rel="stylesheet">
    <link href="../client/style/base.css?" rel="stylesheet">
    <link href="../client/style/iframe.css?" rel="stylesheet">
<style>
    #embed {
        width: 100vw;
        height: 100vh;
        object-fit: contain;
        background: none;
    }
</style>
<style>
    :root {
        --_draw-o: 100.0;
        --_draw-tX: 50.0;
        --_draw-tY: 50.0;
        --_draw-sX: 50.0;
        --_draw-sY: 50.0;
        --_draw-rX: 50.0;
        --_draw-rY: 50.0;
    }
</style>
<style id="public_module_styles"></style>
<style>
    html.edit #embed {
        box-shadow: inset 0 0 25px 25px var(--color-dark);
    }
    main {
        perspective: calc(1 * 1920px);
        transform: translateX(calc(calc(var(--_draw-tX) * -1%) + 50%))
        translateY(calc(calc(var(--_draw-tY) * -1%) + 50%));
    }
    #embed {
        opacity: calc(var(--_draw-o)/100);
        transform: scaleX(calc(calc(var(--_draw-sX) * 0.01) + 0.0))
        scaleY(calc(calc(var(--_draw-sY) * 0.01) + 0.0))
        rotateX(calc(calc(var(--_draw-rY) * 1.8deg) - 90deg))
        rotateY(calc(calc(var(--_draw-rX) * -1.8deg) - 90deg))
        rotateZ(0deg)
        scaleX(-1);
    }
</style>
</head>
<body>
<main>
    <canvas id="embed"></canvas>
</main>
<script>
    document.addEventListener("DOMContentLoaded", () => cssDevWatch());
    document.addEventListener("DOMContentLoaded", () => iframeDetect());
    document.addEventListener("DOMContentLoaded", () => editDetect());
    document.addEventListener("DOMContentLoaded", () => socketConnect());
    document.addEventListener("DOMContentLoaded", () => socketWatchReload());
    document.addEventListener("DOMContentLoaded", () => socketWatchStyle((payload) => {
        let style = payload.split('style:set:')[1];
        document.head.querySelector('#public_module_styles').innerHTML = `:root{${style};}`;
        console.log(`socketWatchStyle :: draw :: set ${style}`);
    }));
    document.addEventListener("DOMContentLoaded", () => socketWatchDrawSet((payload) => {
        if (document.$drawing) {
            console.log('socketWatchDrawSet busy...');
            return;
        }
        document.$drawing = true;
        const pixelSize = 20;
        const playback = payload.split(":")[1].split(",");
        const canvas = document.querySelector("canvas");
        canvas.width = canvas.getBoundingClientRect().width;
        canvas.height = canvas.getBoundingClientRect().height;
        const ctx = document.querySelector("canvas").getContext("2d");
        if (canvas.width > canvas.height) {
            canvas.width = canvas.height;
        }
        if (canvas.height > canvas.width) {
            canvas.height = canvas.width;
        }
        canvas.style.width = `${canvas.width}px`;
        canvas.style.height = `${canvas.height}px`;
        document.replayDone = () => {
            document.$drawing = setTimeout(() => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                document.$drawing = false;
            }, 5000);
        };
        document.replayStart = () => {
            if (playback.length) {
                const x = playback.shift();
                const y = playback.shift();
                ctx.fillStyle = "#2fffa5";
                ctx.beginPath();
                ctx.arc(x, y, (pixelSize * 1.25) / 2, 0, Math.PI * 2, false);
                ctx.fill();
                requestAnimationFrame(document.replayStart);
            } else {
                document.replayDone();
            }
        };
        document.replayStart();
    }));
</script>
</body>
</html>