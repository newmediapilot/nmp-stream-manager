{%extends "layout.html"%}
{%block cdn%}{%endblock%}
{%block client%}{%endblock%}}
{%block head%}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js?{{''|cacheBuster}}" type="text/javascript" crossorigin="anonymous" defer></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js?{{''|cacheBuster}}" type="text/javascript" crossorigin="anonymous" defer></script>
{{ '<script src="../client/script/css_dev_watch.js?" defer type="text/javascript"></script>' | inlineScriptContents | safe }}
{{ '<script src="../client/script/iframe_detect.js?" defer type="text/javascript"></script>' | inlineScriptContents | safe }}
{{ '<script src="../client/script/socket.js?" defer type="text/javascript"></script>' | inlineScriptContents | safe }}
{{ '<script src="../client/script/get_path.js?" defer type="text/javascript"></script>' | inlineScriptContents | safe }}
{{ '<link href="../client/style/variables.css?" rel="stylesheet">' | inlineScriptContents | safe }}
{{ '<link href="../client/style/reset.css?" rel="stylesheet">' | inlineScriptContents | safe }}
{{ '<link href="../client/style/base.css?" rel="stylesheet">' | inlineScriptContents | safe }}
{{ '<link href="../client/style/iframe.css?" rel="stylesheet">' | inlineScriptContents | safe }}
<style>
    #embed {
        width: 100vw;
        height: 100vh;
        object-fit: contain;
        background: none;
    }
</style>
<style>
    :root {
        --_draw-o: 100.0;
        --_draw-tX: 50.0;
        --_draw-tY: 50.0;
        --_draw-sX: 50.0;
        --_draw-sY: 50.0;
        --_draw-rX: 50.0;
        --_draw-rY: 50.0;
    }
</style>
<style id="public_module_styles">:root{{'{'~'public_module_styles'|getParam ~';}'}}</style>
<style>
    html.iframe #embed {
        background-color: #757575;
        opacity: 1;
        background: radial-gradient(circle, transparent 20%, #757575 20%, #757575 80%, transparent 80%, transparent), radial-gradient(circle, transparent 20%, #757575 20%, #757575 80%, transparent 80%, transparent) 25px 25px, linear-gradient(#000000 2px, transparent 2px) 0 -1px, linear-gradient(90deg, #000000 2px, #757575 2px) -1px 0;
        background-size: 50px 50px, 50px 50px, 25px 25px, 25px 25px;
        visibility: visible;
    }
    main {
        perspective: calc(1 * 1920px);
        transform: translateX(calc(calc(var(--_draw-tX) * -1%) + 50%))
        translateY(calc(calc(var(--_draw-tY) * -1%) + 50%))
        scaleX(calc(calc(var(--_draw-sX) * 0.01) + 0.0))
        scaleY(calc(calc(var(--_draw-sY) * 0.01) + 0.0))
    }
    #embed {
        opacity: calc(var(--_draw-o)/100);
        transform: rotateX(calc(calc(var(--_draw-rY) * -1.8deg) - 90deg))
        rotateY(calc(calc(var(--_draw-rX) * -1.8deg) - 90deg));
    }
</style>
{%endblock%}
{%block body%}
<main>
    <canvas id="embed"></canvas>
</main>
{%endblock%}
{%block scripts%}
<script defer>
    document.addEventListener("DOMContentLoaded", () => cssDevWatch());
    document.addEventListener("DOMContentLoaded", () => iframeDetect());
    document.addEventListener("DOMContentLoaded", () => socketConnect());
    document.addEventListener("DOMContentLoaded", () => socketWatchReload());
    document.addEventListener("DOMContentLoaded", () => socketWatchStyle((payload) => {
        let style = payload.split('style:set:')[1];
        document.head.querySelector('#public_module_styles').innerHTML = `:root{${style};}`;
    }));
    document.addEventListener("DOMContentLoaded", () => socketWatchDrawSet((payload) => {
        if (document.$drawing) {
            console.log('socketWatchDrawSet busy...');
            return;
        }
        document.$drawing = true;
        const pixelSize = 20;
        const playback = payload.split(":")[1].split(",");
        const canvas = document.querySelector("canvas");
        canvas.width = canvas.getBoundingClientRect().width;
        canvas.height = canvas.getBoundingClientRect().height;
        const ctx = document.querySelector("canvas").getContext("2d");
        if (canvas.width > canvas.height) {
            canvas.width = canvas.height;
        }
        if (canvas.height > canvas.width) {
            canvas.height = canvas.width;
        }
        canvas.style.width = `${canvas.width}px`;
        canvas.style.height = `${canvas.height}px`;
        document.replayDone = () => {
            document.$drawing = setTimeout(() => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                document.$drawing = false;
            }, 5000);
        };
        document.replayStart = () => {
            if (playback.length) {
                const x = playback.shift();
                const y = playback.shift();
                ctx.fillStyle = "#2fffa5";
                ctx.beginPath();
                ctx.arc(x, y, (pixelSize * 1.25) / 2, 0, Math.PI * 2, false);
                ctx.fill();
                requestAnimationFrame(document.replayStart);
            } else {
                document.replayDone();
            }
        };
        document.replayStart();
    }));
</script>
{%endblock%}