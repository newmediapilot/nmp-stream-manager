<!-- src/views/index.html -->
{% extends "layouts/main.njk" %}
{% set public_routes = 'public_routes' | getParam %}
{% block cdn %}<!-- noscript -->{% endblock %}
{% block local %}<!-- style -->{% endblock %}
{% block hscripts %}
<style>

    html {
        background: url("/image/assets-from-space.webp");
    }

    html,
    body {
        margin: 0;
        padding: 0;
    }

    .pages {
        width: 100vw;
        height: 100vh;
        overflow-x: hidden;
        overflow-y: hidden;
        position: relative;
        margin: 0;
        padding: 0;
        background: repeating-linear-gradient(-45deg, #020202, #131313 15px);
    }

    @media (min-aspect-ratio: 1/1) {
        .pages {
            width: 50%;
            margin-left: 25%;
        }
    }

    .pages iframe {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        left: 0;
        top: 0;
        border: none;
        background: transparent;
    }

</style>
{% endblock %}
{% block body %}
<div class="pages">
    <iframe id="{{public_routes.PUBLIC_SETTINGS}}" src="{{public_routes.PUBLIC_SETTINGS}}"></iframe>
    <iframe id="{{public_routes.PUBLIC_MODULES}}" src="{{public_routes.PUBLIC_MODULES}}"></iframe>
    <iframe id="{{public_routes.PUBLIC_DASHBOARD}}" src="{{public_routes.PUBLIC_DASHBOARD}}"></iframe>
</div>
{% endblock %}
{% block fscripts %}
<script defer crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" defer
        type="text/javascript"></script>
<script defer crossorigin="anonymous" src="https://cdn.socket.io/4.0.0/socket.io.min.js" defer
        type="text/javascript"></script>
<script defer src="/script/socket_connect.js?={{cache_buster}}" type="text/javascript"></script>
<script>
    // If an iframe requests a URL we will find the frame with that path and switch to it
    // Form submissions will usually emit a reload on all frames other than the focused one
    // This means the next click will likely already be past the unload heap
    document.addEventListener("DOMContentLoaded", () => {
        window.addEventListener('message', function (e) {
            if (window.origin === window.location.origin && e.data.type === "path") {
                const iframeReady = () => {
                    iframe.style.display = 'none';
                    iframe.removeEventListener('load', iframeReady);
                    iframe.parentElement.appendChild(iframe);
                    iframe.style.display = 'block';
                    window.location.hash = iframe.getAttribute('id');
                };
                const iframe = document.querySelector(`[src="${e.data.message}"]`);
                iframe.addEventListener('load', iframeReady);
                socketEmitReload();
            }
        });
        // Onload check if we saved a state
        const hash = window.location.hash;
        if (hash) {
            console.log('hash', hash);
            const iframe = document.querySelector(`iframe#${window.location.hash}`);
            console.log('iframe', iframe);
            iframe.parentElement.appendChild(iframe);
        }
    });
</script>
{% endblock %}