{% extends "layouts/main.njk" %}
{% set cache_buster = "" | currentTime %}
{% set public_routes = 'public_routes' | getParam %}
{% block cdn %}<!-- noscript -->{% endblock %}
{% block local %}<!-- nostyle -->{% endblock %}
{% block hscripts %}
<script defer crossorigin="anonymous"
        src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"
        type="text/javascript" defer></script>
<script defer crossorigin="anonymous"
        src="https://cdn.socket.io/4.0.0/socket.io.min.js"
        type="text/javascript" defer></script>
<script defer crossorigin="anonymous"
        src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"
        type="text/javascript" defer></script>
<link rel="stylesheet" href="/style/index.css?cb={{cache_buster}}">
{% endblock %}
{% block body %}
<div class="pages">
    <iframe src="{{public_routes.PUBLIC_MODULES}}"></iframe>
    <iframe src="{{public_routes.PUBLIC_DASHBOARD}}"></iframe>
    <iframe src="{{public_routes.PUBLIC_SETTINGS}}"></iframe>
</div>
{% endblock %}
{% block fscripts %}
<script defer src="/script/socket.js?={{cache_buster}}" type="text/javascript"></script>
<script defer src="/script/detect_press_hold.js?={{cache_buster}}" type="text/javascript"></script>
<script defer>
    document.addEventListener("DOMContentLoaded", () => {
        anime({
            targets: 'body',
            filter: ['sepia(100%)', 'sepia(0%)'], // Animate from full sepia to no sepia
            duration: 10000,
            easing: 'easeOutQuad',
        });
    });
    document.addEventListener("DOMContentLoaded", () => {
        window.addEventListener('message', function (e) {
            if (e.origin === window.location.origin && e.data.type === "path") {
                const iframeEl = Array.from(document.querySelectorAll(`iframe[src="${e.data.message}"]`))[0];
                const indexOf = Array.from(document.querySelectorAll("iframe")).indexOf(iframeEl);
                const vw = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--index-grid-cell-width'));
                const vh = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--index-grid-cell-height'));
                const translateValues = [
                    {translateX: `${1 * vw}vw`, translateY: `${0 * vh}vh`},
                    {translateX: `${0 * vw}vw`, translateY: `${0 * vh}vh`},
                    {translateX: `${-1 * vw}vw`, translateY: `${0 * vh}vh`},
                ];
                const {translateX, translateY} = translateValues[indexOf];
                anime({
                    targets: '.pages',
                    translateX: translateX,
                    translateY: translateY,
                    duration: 333,
                    easing: 'linear',
                    complete: () => {
                        Array.from(document.querySelectorAll("iframe")).forEach((iframe, index) => {
                            iframe.style.display = index === indexOf ? 'flex' : 'none';
                        });
                    }
                });
            }
        });
    });
</script>
{% endblock %}