<!-- src/views/dashboard.html -->
{% extends "layouts/main.njk" %}
{% from "macros/public_module_styles.njk" import public_module_styles %}
{% set cache_buster = "" | currentTime %}
{% set public_routes = 'public_routes' | getParam %}
{% block hscripts %}
<link rel="stylesheet" href="/style/modules.css?cb={{cache_buster}}">
{% endblock %}
{% block body %}
{% include "partials/controls.njk" %}
<style>
    .modules {
        background: cadetblue;
    }

    :root {
        --selector-cell-width: 30px;
        --selector-cell-height: var(--selector-cell-width);
        --selector-width: calc(3 * var(--selector-cell-width));
        --selector-height: calc(3 * var(--selector-cell-height));
    }

    .module .controls {
        display: flex;
    }

    .module .module-9x9-selector ul {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        width: var(--selector-width);
        height: var(--selector-height);
        list-style-type: none;
        margin: 0;
        padding: 0;
        padding: 10px;
    }

    .module .module-9x9-selector li {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .module .module-9x9-selector input[type="radio"] {
        border-radius: 0;
        width: var(--selector-cell-width);
        height: var(--selector-cell-height);
        border: 2px solid var(--button-bloodorange);
        background: var(--button-orange);
    }

    .module .module-9x9-selector input[type="radio"]:checked {
        border-width: 10px;
        background: var(--button-deepyellow);
    }

    .module .preview {
        width: 100%;
        height: 0;
        padding-top: 56.25%;
        background-color: var(--button-black);
        position: relative;
    }

    .module .preview iframe {
        transform: scale(calc(var(--js-module-preview-width) / 1920));
        pointer-events: none;
        border: none;
        background: none;
        position: absolute;
        left: 0;
        top: 0;
        transform-origin: 0 0;
    }

    .module .title label {
        width: 100%;
        height: 100%;
    }

</style>
{% set public_routes = 'public_routes' | getParam %}
{{ public_module_styles() }}
<div class="modules">
    <div class="module">
        <div class="title">
            <h2>BPM</h2>
        </div>
        <div class="preview">
            <iframe width="1920" height="1080" src="{{public_routes.PUBLIC_HEART_EMBED}}"></iframe>
        </div>
        <div class="controls">
            <div class="module-9x9-selector">
                <ul>
                    {% for r1 in [1, 2, 3] %}{% for c1 in [1, 2, 3] %}
                    <li>
                        <input onclick="javascript:pushStyleUpdates()" type="radio" name="group1"
                               value="--heart-grid-column-start:{{ c1 }}; --heart-grid-column-end:{{ c1 + 1 }};--heart-grid-row-start:{{ r1 }}; --heart-grid-row-end:{{ r1 + 1 }};">
                    </li>
                    {% endfor %}{% endfor %}
                </ul>
            </div>
            <div class="module-9x9-selector">
                <ul>
                    {% for r1 in ['flex-start', 'center', 'end'] %}{% for c1 in ['flex-start', 'center', 'end'] %}
                    <li>
                        <input onclick="javascript:pushStyleUpdates()" type="radio" name="group2"
                               value="--heart-align-self:{{ r1 }}; --heart-justify-self:{{ c1 }};">
                    </li>
                    {% endfor %}{% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block fscripts %}
<script>
    // document.addEventListener("DOMContentLoaded", () => socketWatchReload());
    document.addEventListener("DOMContentLoaded", () => setupCssVariable('.preview', 'width', '--js-module-preview-width'));
    document.addEventListener("DOMContentLoaded", () => {
        document.pushStyleUpdates = () => {
            const payload = Array.from(document.querySelectorAll('input[type="radio"]:checked')).map(el => el.value).join("");
            console.log('pushStyleUpdates::payload', payload);
            payload && axios.get("/public/style/update", {
                    params: {
                        type: "style",
                        payload
                    },
                })
                .finally(() => {
                    socketEmitReload();
                    console.log('pushStyleUpdates::socketEmitReload');
                });

        };
    });
</script>
{% endblock %}