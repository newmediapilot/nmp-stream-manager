{%extends "layouts/main.njk"%}
{%set cache_buster = "" | currentTime%}
{%set public_routes = "public_routes"|getParam%}
{%block head%}
<script defer type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
<style>
    html {
        width: 100vw;
        height: 100vh;
    }

    body {
        width: 100vw;
        height: 100vh;
    }

    nav {
        transform: none;
        left: 0;
        bottom: 150px;
    }

    canvas {
        width: 100vw;
        height: 100vw;
        opacity: 1;
        background-image: linear-gradient(rgba(0, 0, 0, .1) 2px, transparent 2px),
        linear-gradient(90deg, rgba(0, 0, 0, .1) 2px, transparent 2px),
        linear-gradient(rgba(0, 0, 0, .1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 0, 0, .1) 1px, rgba(255, 255, 255, .1) 1px);
        background-size: 50px 50px, 50px 50px, 10px 10px, 10px 10px;
        background-position: -2px -2px, -2px -2px, -1px -1px, -1px -1px;
    }
</style>
{%endblock%}
{%block body%}
<section>
    <canvas id="canvas"></canvas>
    <input disabled type="range" min="0" max="1000" value="max" step="1">
    <button onclick="javascript: document.clearCanvas()">WIPE</button>
    <button onclick="javascript: document.sendPayload()">SEND</button>
</section>
<nav>
    <label onclick="javascript:getURL('{{public_routes.PANEL_DASHBOARD}}')" aria-label="ðŸŒ€"></label>
</nav>
{%endblock%}
{%block fscripts%}
<script defer>
    document.addEventListener("DOMContentLoaded", () => iframeDetect());
    document.addEventListener("DOMContentLoaded", () => socketConnect());
    document.addEventListener("DOMContentLoaded", () => socketWatchReload());
    document.addEventListener("DOMContentLoaded", () => {
        let recording = [];
        let capture = [];
        const pixelSize = 20;
        const canvas = document.querySelector("canvas");
        canvas.width = canvas.getBoundingClientRect().width;
        canvas.height = canvas.getBoundingClientRect().height;
        const ctx = document.querySelector("canvas").getContext("2d");
        document.clearCanvas = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            recording = [];
            capture = [];
        };
        document.sendPayload = () => {
            window.replayStart();
            console.log('recording', recording);
        };
        window.replayDone = () => {
            // document.clearCanvas();
            setTimeout(() => requestAnimationFrame(window.replayStart), 4);
        };
        document.drawPixel = (x, y) => {
            ctx.fillStyle = "#ff7b00";
            ctx.beginPath();
            ctx.arc(x, y, pixelSize / 2, 0, Math.PI * 2, false);
            ctx.fill();
            capture.push(x);
            recording.push(x);
            capture.push(y);
            recording.push(y);
            document.querySelector('[type=range]').value = capture.length;
        };
        window.replayStart = () => {
            if (!capture.length) {
                window.replayDone();
            }
            const x = capture.shift();
            const y = capture.shift();
            ctx.fillStyle = "#2fffa5";
            ctx.beginPath();
            ctx.arc(x, y, (pixelSize * 1.25) / 2, 0, Math.PI * 2, false);
            ctx.fill();
            document.querySelector('[type=range]').value = capture.length;
            setTimeout(() => requestAnimationFrame(window.replayStart), 4);
        };
        window.addEventListener("touchmove", (e) => document.drawPixel(
            e.touches[0].pageX,
            e.touches[0].pageY,
        ));
    });
</script>
{%endblock%}